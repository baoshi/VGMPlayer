#include "lvspectrum.h"

//
// Spectrum display
//
#define LV_SPECTRUM_GAP 1
#define LV_SPECTRUM_BLOWLINE_HEIGHT 2

static const uint32_t lv_spectrum_blowline_color = 0xffffff;

static const uint32_t lv_spectrum_colors[LV_SPECTRUM_BIN_SEGMENTS][LV_SPECTRUM_MAX_BINS] =
{
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xaaff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa8, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xcfff00, 0xaaff00, 0x83ff00, 0x37ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0xa000ff, 0xb900ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc100, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xabff00, 0x83ff00, 0x37ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcb, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe101ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9600, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa8, 0x00ffcb, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0400ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xceff00, 0xabff00, 0x84ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa8, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0400ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe101ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa8, 0x00ffcb, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xceff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6200, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xceff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6200, 0xff9700, 0xffc000, 0xffe500, 0xfffd00, 0xecff00, 0xceff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcb, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0400ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xcf00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xcfff00, 0xabff00, 0x83ff00, 0x38ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe101ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc100, 0xffe400, 0xfffd00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa8, 0x00ffcc, 0x00ffe9, 0x00ffff, 0x00b1ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0400ff, 0x4b00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2800, 0xff6100, 0xff9600, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xaaff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa8, 0x00ffcb, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xceff00, 0xaaff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcb, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe101ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe500, 0xfffe00, 0xecff00, 0xceff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xcf00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2800, 0xff6100, 0xff9600, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0400ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6200, 0xff9600, 0xffc100, 0xffe400, 0xfffe00, 0xebff00, 0xcfff00, 0xabff00, 0x83ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa8, 0x00ffcc, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0400ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc000, 0xffe500, 0xfffd00, 0xecff00, 0xcfff00, 0xaaff00, 0x84ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9600, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe100ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc100, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xaaff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0400ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9600, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xabff00, 0x83ff00, 0x37ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa7, 0x00ffcb, 0x00ffe9, 0x00ffff, 0x00b1ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe101ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9700, 0xffc100, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff35, 0x00ff80, 0x00ffa8, 0x00ffcc, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xcf00ff, 0xe101ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2800, 0xff6100, 0xff9700, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x37ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcc, 0x00ffe9, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003cff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb900ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6200, 0xff9700, 0xffc000, 0xffe400, 0xfffd00, 0xecff00, 0xcfff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa7, 0x00ffcb, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4a00ff, 0x8500ff, 0xa000ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
    {0xff0200, 0xff0200, 0xff2900, 0xff6100, 0xff9600, 0xffc000, 0xffe400, 0xfffe00, 0xecff00, 0xceff00, 0xabff00, 0x84ff00, 0x38ff00, 0x00ff00, 0x00ff34, 0x00ff80, 0x00ffa8, 0x00ffcb, 0x00ffea, 0x00ffff, 0x00b2ff, 0x0067ff, 0x003bff, 0x0017ff, 0x0300ff, 0x4b00ff, 0x8500ff, 0x9f00ff, 0xb800ff, 0xce00ff, 0xe001ff, 0xee02ff},
};


static void lv_spectrum_on_size_changed(lv_obj_t *obj)
{
    // Update spectrum display parameters
    lv_spectrum_t* spectrum = (lv_spectrum_t *)obj;
    lv_area_t rect;
    lv_obj_get_content_coords(obj, &rect);
    int width = rect.x2 - rect.x1 + 1;
    int height = rect.y2 - rect.y1 + 1;
    int temp, count;
    // find width of each bin, reduce number of bins if necessary
    count = spectrum->bin_count;
    // total width = count * bin_width + (count - 1) * GAP
    while (1)
    {
        temp = (width - (count - 1) * LV_SPECTRUM_GAP) / count;
        if (temp >= 1) break;
        --count;
    }
    spectrum->bin_width = temp;
    spectrum->bin_count = count;
    // find height of each segment
    count = LV_SPECTRUM_BIN_SEGMENTS;
    // total height = BLOWLINE_HEIGHT + count * seg_height + count * GAP
    while (1)
    {
        temp = (height - count * LV_SPECTRUM_GAP - LV_SPECTRUM_BLOWLINE_HEIGHT) / count;
        if (temp >= LV_SPECTRUM_BLOWLINE_HEIGHT) break;
        --count;
        if (count == 0) break;
    }
    spectrum->bin_segment_count = count;
    spectrum->bin_segment_height = temp;
    spectrum->bin_start_x = (width - spectrum->bin_width * spectrum->bin_count - (spectrum->bin_count - 1) * LV_SPECTRUM_GAP) / 2;
}



static void lv_spectrum_constructor(const lv_obj_class_t* class_p, lv_obj_t* obj)
{
    lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
    spectrum->bin_count = LV_SPECTRUM_MAX_BINS;
    lv_memset_00(spectrum->bin_values, spectrum->bin_count * sizeof(uint8_t));
    spectrum->bin_count = LV_SPECTRUM_MAX_BINS;
    //lv_obj_remove_style_all(obj);
    lv_obj_clear_flag(obj, LV_OBJ_FLAG_CLICKABLE | LV_OBJ_FLAG_SCROLLABLE);
}


static void lv_spectrum_destructor(const lv_obj_class_t* class_p, lv_obj_t* obj)
{
    LV_ASSERT_OBJ(obj, &lv_spectrum_class);
    lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
}


static void lv_spectrum_event(const lv_obj_class_t* class_p, lv_event_t* e)
{
    lv_res_t res = lv_obj_event_base(&lv_spectrum_class, e);
    if (res != LV_RES_OK) return;
    lv_event_code_t code = lv_event_get_code(e);
    lv_obj_t* obj = lv_event_get_target(e);
    if (code == LV_EVENT_SIZE_CHANGED)
    {
        lv_spectrum_on_size_changed(obj);
    }
    else if (code == LV_EVENT_DRAW_MAIN)
    {
        lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
        lv_draw_ctx_t* draw_ctx = lv_event_get_draw_ctx(e);
        lv_opa_t opa = lv_obj_get_style_opa(obj, LV_PART_MAIN);
        if (opa < LV_OPA_MIN) return;

        if (spectrum->bin_count <= 0 || spectrum->bin_segment_count <= 0) return;

        lv_area_t content_rect;
        lv_obj_get_content_coords(obj, &content_rect);
        lv_draw_rect_dsc_t draw_rect_dsc;
        lv_draw_rect_dsc_init(&draw_rect_dsc);
        draw_rect_dsc.bg_opa = LV_OPA_COVER;
        lv_area_t segment;
        segment.x1 = content_rect.x1 + spectrum->bin_start_x;
        for (int bin = 0; bin < spectrum->bin_count; ++bin)
        {
            segment.x2 = segment.x1 + spectrum->bin_width - 1;
            segment.y2 = content_rect.y2;
            int segs = spectrum->bin_values[bin] * (spectrum->bin_segment_count - 1) / 255 + 1;
            if (segs >= spectrum->bin_segment_count)
                segs = spectrum->bin_segment_count;
            for (int seg = 0; seg < segs; ++seg)
            {
                segment.y1 = segment.y2 - spectrum->bin_segment_height + 1;
                draw_rect_dsc.bg_color = lv_color_hex(lv_spectrum_colors[seg][bin]);
                lv_draw_rect(draw_ctx, &draw_rect_dsc, &segment);
                segment.y2 = segment.y1 - LV_SPECTRUM_GAP - 1;
            }
            segment.x1 = segment.x2 + LV_SPECTRUM_GAP + 1;
        }
    }
}


const lv_obj_class_t lv_spectrum_class =
{
    .constructor_cb = lv_spectrum_constructor,
    .destructor_cb = lv_spectrum_destructor,
    .event_cb = lv_spectrum_event,
    .instance_size = sizeof(lv_spectrum_t),
    .base_class = &lv_obj_class,
    .width_def = 300,
    .height_def = 200
};


lv_obj_t* lv_spectrum_create(lv_obj_t* parent)
{
    lv_obj_t* obj = lv_obj_class_create_obj(&lv_spectrum_class, parent);
    LV_ASSERT_MALLOC(obj);
    lv_obj_class_init_obj(obj);
    return obj;
}


void lv_spectrum_set_bin_values(lv_obj_t *obj, const uint8_t *bvs, int len)
{
    LV_ASSERT_OBJ(obj, &lv_spectrum_class);
    lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
    len = LV_MIN(len, LV_SPECTRUM_MAX_BINS);
    bool relayout = (len != spectrum->bin_count);
    spectrum->bin_count = len;
    memcpy(spectrum->bin_values, bvs, spectrum->bin_count * sizeof(uint8_t));
    if (relayout)
        lv_spectrum_on_size_changed(obj);
    lv_obj_invalidate(obj);
}

