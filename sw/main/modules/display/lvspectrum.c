#include "lvspectrum.h"

//
// Spectrum display
//
#define LV_SPECTRUM_GAP 1
#define LV_SPECTRUM_BLOWLINE_HEIGHT 2

static const uint32_t lv_spectrum_blowline_color = 0xffffff;

static const uint32_t lv_spectrum_colors[LV_SPECTRUM_BIN_SEGMENTS][LV_SPECTRUM_MAX_BINS] =
{
    {0xfe1602, 0xfb3800, 0xf65700, 0xee7700, 0xe29800, 0xd2b700, 0xbdd500, 0xa6ee00, 0x90ff00, 0x8aff28, 0x82ff43, 0x77ff5d, 0x6aff77, 0x5aff92, 0x47ffad, 0x31ffc8, 0x00ffdf, 0x00ebed, 0x00d0f7, 0x00b0fe, 0x008eff, 0x006bff, 0x004aff, 0x002afe, 0x1601fd, 0x2d00fc, 0x4400fb, 0x5f00fa, 0x8013f7, 0xa31af4, 0xc81cf2, 0xe717ee},
    {0xfd1605, 0xfb3705, 0xf65704, 0xee7804, 0xe29805, 0xd2b705, 0xbed504, 0xa6ee05, 0x91ff04, 0x8aff27, 0x82ff43, 0x77ff5d, 0x6aff77, 0x5aff92, 0x47ffad, 0x31ffc7, 0x04ffdf, 0x04ebec, 0x05d0f7, 0x05b0fe, 0x058eff, 0x046bff, 0x054aff, 0x042afe, 0x1504fd, 0x2d04fc, 0x4305fb, 0x5f04f9, 0x7f13f7, 0xa31af4, 0xc81cf2, 0xe818ee},
    {0xfe1609, 0xfb3709, 0xf75709, 0xee7709, 0xe29809, 0xd2b708, 0xbed509, 0xa6ed09, 0x91ff09, 0x8aff28, 0x81ff43, 0x77ff5d, 0x6aff78, 0x5aff92, 0x47ffad, 0x31ffc7, 0x08ffdf, 0x09ebed, 0x09d0f7, 0x08b0fe, 0x098dff, 0x086bff, 0x094aff, 0x0929fe, 0x1608fd, 0x2d08fc, 0x4408fb, 0x6009f9, 0x7f12f7, 0xa31af5, 0xc71cf1, 0xe818ee},
    {0xfe160f, 0xfb370e, 0xf6570e, 0xee780e, 0xe2980e, 0xd2b70e, 0xbdd50e, 0xa6ed0e, 0x91ff0e, 0x8aff28, 0x82ff42, 0x77ff5d, 0x69ff77, 0x5aff92, 0x47ffad, 0x31ffc7, 0x0effdf, 0x0eeced, 0x0ed1f7, 0x0eb0fe, 0x0e8eff, 0x0e6bff, 0x0e4aff, 0x0e29ff, 0x160ffd, 0x2c0efc, 0x440efb, 0x5f0ef9, 0x7f13f7, 0xa31af4, 0xc81cf1, 0xe818ef},
    {0xfe1614, 0xfb3715, 0xf65714, 0xee7714, 0xe29814, 0xd2b814, 0xbdd514, 0xa6ed15, 0x91ff14, 0x8aff28, 0x82ff42, 0x77ff5c, 0x6aff77, 0x5aff92, 0x47ffac, 0x31ffc7, 0x14ffdf, 0x14ecec, 0x14d1f7, 0x14b0fd, 0x148eff, 0x146bff, 0x144aff, 0x142aff, 0x1714fd, 0x2d15fb, 0x4314fb, 0x6014f9, 0x7f16f7, 0xa41af5, 0xc71df2, 0xe718ef},
    {0xfe1c1b, 0xfc371b, 0xf7571b, 0xee781a, 0xe3981b, 0xd2b81a, 0xbdd51a, 0xa5ed1a, 0x91ff1b, 0x8aff27, 0x81ff43, 0x77ff5d, 0x69ff77, 0x5aff92, 0x47ffac, 0x31ffc7, 0x1bffdf, 0x1aecec, 0x1ad0f6, 0x1bb0fe, 0x1b8dff, 0x1a6bff, 0x1a49ff, 0x1a29fe, 0x1d1afd, 0x2d1bfc, 0x441afa, 0x5f1af9, 0x801cf7, 0xa41df4, 0xc71df1, 0xe71dee},
    {0xfe2422, 0xfb3721, 0xf65722, 0xef7721, 0xe29822, 0xd3b821, 0xbdd521, 0xa5ed21, 0x91ff21, 0x8aff27, 0x81ff42, 0x77ff5c, 0x6aff77, 0x5aff92, 0x47ffad, 0x31ffc7, 0x22ffdf, 0x21eced, 0x22d1f7, 0x21b0fe, 0x228eff, 0x216bff, 0x214aff, 0x2229fe, 0x2321fd, 0x2d21fc, 0x4421fb, 0x5f21f9, 0x8023f7, 0xa324f4, 0xc724f1, 0xe724ee},
    {0xfe2c2a, 0xfc3729, 0xf65729, 0xee7829, 0xe39829, 0xd2b729, 0xbdd529, 0xa6ee29, 0x91ff29, 0x8aff2d, 0x82ff43, 0x77ff5d, 0x6aff77, 0x5aff92, 0x48ffac, 0x31ffc8, 0x29ffdf, 0x29eced, 0x29d1f7, 0x29b0fd, 0x298eff, 0x296bff, 0x2949ff, 0x292dfe, 0x2b2afd, 0x2e29fc, 0x4329fb, 0x5f29f9, 0x802af7, 0xa42bf4, 0xc72cf1, 0xe82bee},
    {0xfe3331, 0xfb3731, 0xf65631, 0xef7731, 0xe39831, 0xd2b831, 0xbed531, 0xa6ee31, 0x91ff31, 0x8aff35, 0x82ff42, 0x77ff5d, 0x69ff77, 0x5aff92, 0x47ffac, 0x36ffc7, 0x31ffdf, 0x31eced, 0x31d0f7, 0x31b0fd, 0x318dff, 0x316bff, 0x3149ff, 0x3135fe, 0x3331fd, 0x3531fc, 0x4431fb, 0x6031fa, 0x8032f7, 0xa333f4, 0xc733f2, 0xe833ee},
    {0xfe3b39, 0xfb3e39, 0xf65739, 0xee7739, 0xe29839, 0xd3b739, 0xbdd539, 0xa6ee39, 0x91ff39, 0x8aff3d, 0x81ff42, 0x77ff5c, 0x69ff77, 0x5aff92, 0x48ffad, 0x3effc7, 0x39ffdf, 0x39ecec, 0x39d0f7, 0x39b0fe, 0x398eff, 0x396bff, 0x394aff, 0x393dfe, 0x3b39fd, 0x3e39fc, 0x4339fb, 0x5f39f9, 0x803bf7, 0xa33bf4, 0xc83cf1, 0xe73bee},
    {0xfe4341, 0xfb4742, 0xf65742, 0xef7742, 0xe29841, 0xd2b841, 0xbdd541, 0xa6ed42, 0x91ff41, 0x8aff46, 0x81ff48, 0x77ff5d, 0x6aff78, 0x5aff92, 0x48ffad, 0x46ffc7, 0x42ffdf, 0x41ebed, 0x41d0f7, 0x41b0fe, 0x428eff, 0x416bff, 0x4149ff, 0x4146ff, 0x4441fd, 0x4641fc, 0x4842fb, 0x5f42fa, 0x7f44f7, 0xa444f4, 0xc744f2, 0xe843ee},
    {0xfe4c4a, 0xfb4f4a, 0xf6574a, 0xee774a, 0xe2984a, 0xd2b84a, 0xbed54a, 0xa6ee4a, 0x91ff4a, 0x8aff4e, 0x82ff50, 0x76ff5c, 0x6aff77, 0x5aff92, 0x51ffad, 0x4fffc7, 0x4affdf, 0x4aecec, 0x4ad0f6, 0x4ab0fd, 0x4a8eff, 0x4a6bff, 0x4a51ff, 0x4a4efe, 0x4c4afd, 0x4e4afc, 0x514afb, 0x5f4afa, 0x7f4cf7, 0xa34df4, 0xc84df1, 0xe74cee},
    {0xfe5553, 0xfb5852, 0xf65b53, 0xee7753, 0xe29853, 0xd3b853, 0xbdd553, 0xa6ed53, 0x91ff53, 0x8aff57, 0x82ff59, 0x77ff5d, 0x69ff77, 0x5cff92, 0x5affac, 0x58ffc7, 0x53ffdf, 0x53eced, 0x53d1f7, 0x53b1fd, 0x538eff, 0x526bff, 0x535aff, 0x5357ff, 0x5553fd, 0x5753fc, 0x5a53fa, 0x6053f9, 0x7f55f7, 0xa356f5, 0xc855f1, 0xe755ee},
    {0xfe5d5c, 0xfb615c, 0xf6655c, 0xee775c, 0xe3985c, 0xd3b75c, 0xbdd55c, 0xa5ee5c, 0x91ff5c, 0x8aff60, 0x82ff62, 0x77ff65, 0x69ff77, 0x65ff92, 0x63ffad, 0x61ffc8, 0x5bffdf, 0x5cecec, 0x5cd0f6, 0x5cb0fe, 0x5c8dff, 0x5c6bff, 0x5c63ff, 0x5c60fe, 0x5e5cfd, 0x605cfc, 0x635cfb, 0x655cf9, 0x805ef7, 0xa45ff5, 0xc75ff1, 0xe85eee},
    {0xfe6765, 0xfb6a65, 0xf66e65, 0xee7765, 0xe39865, 0xd2b865, 0xbdd565, 0xa5ee65, 0x91ff65, 0x8aff69, 0x82ff6b, 0x77ff6e, 0x70ff77, 0x6eff92, 0x6cffac, 0x6affc7, 0x66ffdf, 0x65ecec, 0x65d0f7, 0x66b0fe, 0x658eff, 0x6570ff, 0x656cff, 0x656afe, 0x6865fd, 0x6965fc, 0x6c65fb, 0x6e65f9, 0x7f67f7, 0xa468f5, 0xc768f1, 0xe768ee},
    {0xfe706f, 0xfb736e, 0xf6776e, 0xef7a6f, 0xe2986e, 0xd2b86f, 0xbdd56e, 0xa5ee6e, 0x91ff6f, 0x8aff72, 0x81ff75, 0x7aff77, 0x78ff7b, 0x77ff92, 0x76ffad, 0x74ffc8, 0x6effdf, 0x6eecec, 0x6fd0f7, 0x6eb0fd, 0x6f8eff, 0x6e79ff, 0x6e75ff, 0x6e72ff, 0x716efd, 0x726efc, 0x756efb, 0x776ff9, 0x8071f7, 0xa471f4, 0xc871f1, 0xe870ee},
    {0xfe7977, 0xfb7c78, 0xf68078, 0xee8477, 0xe29878, 0xd2b778, 0xbdd578, 0xa6ed78, 0x91ff77, 0x8aff7b, 0x85ff7e, 0x84ff81, 0x82ff84, 0x81ff92, 0x7fffad, 0x7dffc8, 0x78ffdf, 0x78eced, 0x77d0f7, 0x78b0fd, 0x788dff, 0x7782ff, 0x777fff, 0x787bfe, 0x7a78fd, 0x7b78fc, 0x7f77fb, 0x8077fa, 0x857af7, 0xa47bf4, 0xc87bf1, 0xe77aef},
    {0xfe8381, 0xfb8681, 0xf68981, 0xee8c81, 0xe29881, 0xd3b881, 0xbdd581, 0xa5ee81, 0x91ff81, 0x8eff85, 0x8eff87, 0x8dff8a, 0x8bff8c, 0x8aff92, 0x88ffad, 0x85ffc7, 0x81ffdf, 0x80ebed, 0x81d1f7, 0x81b0fe, 0x818fff, 0x818bff, 0x8188ff, 0x8185fe, 0x8381fd, 0x8581fc, 0x8880fb, 0x8a81f9, 0x8e83f7, 0xa484f4, 0xc784f1, 0xe782ef},
    {0xfe8c8a, 0xfb908b, 0xf6928b, 0xee968a, 0xe2998a, 0xd3b88a, 0xbdd58a, 0xa6ee8a, 0x98ff8a, 0x98ff8e, 0x97ff91, 0x96ff93, 0x94ff96, 0x93ff98, 0x91ffad, 0x8fffc7, 0x8affdf, 0x8aeced, 0x8ad0f7, 0x8ab0fd, 0x8a98ff, 0x8a94ff, 0x8a91ff, 0x8a8efe, 0x8c8afd, 0x8e8afc, 0x918afb, 0x938afa, 0x978cf7, 0xa38df4, 0xc78ef1, 0xe78cee},
    {0xfe9593, 0xfb9893, 0xf69c93, 0xee9f93, 0xe3a293, 0xd2b793, 0xbdd593, 0xa6ee93, 0xa2ff93, 0xa1ff97, 0xa0ff9a, 0x9fff9c, 0x9dff9f, 0x9cffa1, 0x9affac, 0x98ffc7, 0x93ffdf, 0x93ebec, 0x94d1f7, 0x93b0fd, 0x94a2ff, 0x939eff, 0x939aff, 0x9397fe, 0x9593fd, 0x9793fc, 0x9a93fb, 0x9c93f9, 0xa095f7, 0xa396f4, 0xc897f1, 0xe795ee},
    {0xfe9e9c, 0xfba19c, 0xf6a59c, 0xeea89c, 0xe2ab9c, 0xd2b89c, 0xbdd59c, 0xacee9c, 0xaaff9c, 0xaaffa0, 0xa9ffa3, 0xa8ffa5, 0xa6ffa8, 0xa5ffaa, 0xa3ffad, 0xa1ffc7, 0x9cffdf, 0x9cebec, 0x9cd1f7, 0x9cb0fe, 0x9caaff, 0x9ca7ff, 0x9ca3ff, 0x9ca0fe, 0x9e9cfd, 0xa09cfc, 0xa39cfb, 0xa59cf9, 0xa99ef7, 0xac9ff4, 0xc89ff1, 0xe89eee},
    {0xfea6a5, 0xfbaaa4, 0xf6ada5, 0xeeb1a5, 0xe2b3a5, 0xd2b7a5, 0xbdd5a5, 0xb4eea4, 0xb3ffa5, 0xb2ffa9, 0xb2ffab, 0xb1ffae, 0xafffb0, 0xadffb3, 0xacffb6, 0xaaffc7, 0xa4ffdf, 0xa5ebec, 0xa4d0f7, 0xa5b6fe, 0xa4b2ff, 0xa5afff, 0xa5acff, 0xa4a8fe, 0xa7a5fd, 0xa9a5fc, 0xaba5fb, 0xaea4fa, 0xb2a6f7, 0xb5a7f5, 0xc8a8f2, 0xe7a7ee},
    {0xfeafad, 0xfbb3ad, 0xf7b6ad, 0xeeb9ad, 0xe2bcad, 0xd2bfad, 0xc0d5ad, 0xbdedad, 0xbbffad, 0xbbffb1, 0xbaffb4, 0xb9ffb6, 0xb8ffb9, 0xb6ffbb, 0xb4ffbe, 0xb2ffc8, 0xadffdf, 0xadebec, 0xadd0f7, 0xadbefd, 0xadbbff, 0xadb8ff, 0xadb4ff, 0xadb1ff, 0xafadfd, 0xb2adfc, 0xb4adfb, 0xb6adf9, 0xbaaff7, 0xbdb0f4, 0xc8b0f1, 0xe7b0ee},
    {0xfeb8b5, 0xfbbbb5, 0xf6beb5, 0xeec1b5, 0xe3c4b5, 0xd3c7b5, 0xc8d5b5, 0xc6eeb5, 0xc4ffb5, 0xc3ffb9, 0xc2ffbc, 0xc1ffbe, 0xc0ffc1, 0xbeffc4, 0xbcffc6, 0xbaffc9, 0xb5ffdf, 0xb5ebed, 0xb5d0f6, 0xb5c7fd, 0xb5c3ff, 0xb5c0ff, 0xb5bcff, 0xb5b9fe, 0xb8b5fd, 0xbab5fc, 0xbcb5fb, 0xbfb5f9, 0xc2b7f7, 0xc5b8f4, 0xc9b8f2, 0xe8b8ef},
};


static void lv_spectrum_on_size_changed(lv_obj_t *obj)
{
    // Update spectrum display parameters
    lv_spectrum_t* spectrum = (lv_spectrum_t *)obj;
    lv_area_t rect;
    lv_obj_get_content_coords(obj, &rect);
    int width = rect.x2 - rect.x1 + 1;
    int height = rect.y2 - rect.y1 + 1;
    int temp, count;
    // find width of each bin, reduce number of bins if necessary
    count = spectrum->bin_count;
    // total width = count * bin_width + (count - 1) * GAP
    while (1)
    {
        temp = (width - (count - 1) * LV_SPECTRUM_GAP) / count;
        if (temp >= 1) break;
        --count;
    }
    spectrum->bin_width = temp;
    spectrum->bin_count = count;
    // find height of each segment
    count = LV_SPECTRUM_BIN_SEGMENTS;
    // total height = BLOWLINE_HEIGHT + count * seg_height + count * GAP
    while (1)
    {
        temp = (height - count * LV_SPECTRUM_GAP - LV_SPECTRUM_BLOWLINE_HEIGHT) / count;
        if (temp >= LV_SPECTRUM_BLOWLINE_HEIGHT) break;
        --count;
        if (count == 0) break;
    }
    spectrum->bin_segment_count = count;
    spectrum->bin_segment_height = temp;
    spectrum->bin_start_x = (width - spectrum->bin_width * spectrum->bin_count - (spectrum->bin_count - 1) * LV_SPECTRUM_GAP) / 2;
}



static void lv_spectrum_constructor(const lv_obj_class_t* class_p, lv_obj_t* obj)
{
    lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
    spectrum->bin_count = LV_SPECTRUM_MAX_BINS;
    lv_memset_00(spectrum->bin_values, spectrum->bin_count * sizeof(uint8_t));
    spectrum->bin_count = LV_SPECTRUM_MAX_BINS;
    //lv_obj_remove_style_all(obj);
    lv_obj_clear_flag(obj, LV_OBJ_FLAG_CLICKABLE | LV_OBJ_FLAG_SCROLLABLE);
}


static void lv_spectrum_destructor(const lv_obj_class_t* class_p, lv_obj_t* obj)
{
    LV_ASSERT_OBJ(obj, &lv_spectrum_class);
    lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
}


static void lv_spectrum_event(const lv_obj_class_t* class_p, lv_event_t* e)
{
    lv_res_t res = lv_obj_event_base(&lv_spectrum_class, e);
    if (res != LV_RES_OK) return;
    lv_event_code_t code = lv_event_get_code(e);
    lv_obj_t* obj = lv_event_get_target(e);
    if (code == LV_EVENT_SIZE_CHANGED)
    {
        lv_spectrum_on_size_changed(obj);
    }
    else if (code == LV_EVENT_DRAW_MAIN)
    {
        lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
        lv_draw_ctx_t* draw_ctx = lv_event_get_draw_ctx(e);
        lv_opa_t opa = lv_obj_get_style_opa(obj, LV_PART_MAIN);
        if (opa < LV_OPA_MIN) return;

        if (spectrum->bin_count <= 0 || spectrum->bin_segment_count <= 0) return;

        lv_area_t content_rect;
        lv_obj_get_content_coords(obj, &content_rect);
        lv_draw_rect_dsc_t draw_rect_dsc;
        lv_draw_rect_dsc_init(&draw_rect_dsc);
        draw_rect_dsc.bg_opa = LV_OPA_COVER;
        lv_area_t segment;
        segment.x1 = content_rect.x1 + spectrum->bin_start_x;
        for (int bin = 0; bin < spectrum->bin_count; ++bin)
        {
            segment.x2 = segment.x1 + spectrum->bin_width - 1;
            segment.y2 = content_rect.y2;
            int segs = spectrum->bin_values[bin] * (spectrum->bin_segment_count - 1) / 255 + 1;
            if (segs >= spectrum->bin_segment_count)
                segs = spectrum->bin_segment_count;
            for (int seg = 0; seg < segs; ++seg)
            {
                segment.y1 = segment.y2 - spectrum->bin_segment_height + 1;
                draw_rect_dsc.bg_color = lv_color_hex(lv_spectrum_colors[seg][bin]);
                lv_draw_rect(draw_ctx, &draw_rect_dsc, &segment);
                segment.y2 = segment.y1 - LV_SPECTRUM_GAP - 1;
            }
            segment.x1 = segment.x2 + LV_SPECTRUM_GAP + 1;
        }
    }
}


const lv_obj_class_t lv_spectrum_class =
{
    .constructor_cb = lv_spectrum_constructor,
    .destructor_cb = lv_spectrum_destructor,
    .event_cb = lv_spectrum_event,
    .instance_size = sizeof(lv_spectrum_t),
    .base_class = &lv_obj_class,
    .width_def = 300,
    .height_def = 200
};


lv_obj_t* lv_spectrum_create(lv_obj_t* parent)
{
    lv_obj_t* obj = lv_obj_class_create_obj(&lv_spectrum_class, parent);
    LV_ASSERT_MALLOC(obj);
    lv_obj_class_init_obj(obj);
    return obj;
}


void lv_spectrum_set_bin_values(lv_obj_t *obj, const uint8_t *bvs, int len)
{
    LV_ASSERT_OBJ(obj, &lv_spectrum_class);
    lv_spectrum_t* spectrum = (lv_spectrum_t*)obj;
    len = LV_MIN(len, LV_SPECTRUM_MAX_BINS);
    bool relayout = (len != spectrum->bin_count);
    spectrum->bin_count = len;
    memcpy(spectrum->bin_values, bvs, spectrum->bin_count * sizeof(uint8_t));
    if (relayout)
        lv_spectrum_on_size_changed(obj);
    lv_obj_invalidate(obj);
}

